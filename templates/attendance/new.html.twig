{% extends 'base.html.twig' %}

{% block title %}{% trans %}New Attendance{% endtrans %}{% endblock %}

{% block body %}
    <ol class="breadcrumb">
	<li class="breadcrumb-item"><a href="www.gob.mx"><i class="icon icon-home"></i></a></li>
	<li class="breadcrumb-item"><a href="{{ path('app_index') }}">{% trans %}Begin{% endtrans %}</a></li>
	<li class="breadcrumb-item"><a href="{{ path('app_attendance_index') }}">{% trans %}Attendance{% endtrans %}</a></li>
	<li class="breadcrumb-item active" aria-current="page"><a href="{{ path('app_attendance_new') }}">{% trans %}New Attendance{% endtrans %}</a></li>
    </ol>

    <h1>{% trans %}Create new Attendance{% endtrans %}</h1>
    <hr class="red">

    <div class="row">
	<div class="col-md-6">
	    {{ form_start(form) }}
		<div class="form-group">
		    {{ form_label(form.patient) }}:
		    <div class="row">
			<div class="col-md">
			    {{ form_widget(form.patient) }}
			    <span class="text-danger">{{ form_errors(form.patient) }}</span>
			</div>
		    </div>
		</div>
		<div class="form-group">
		    {{ form_label(form.tag) }}:
		    <div class="row">
			<div class="col-md">
			    {{ form_widget(form.tag) }}
			    <span class="text-danger">{{ form_errors(form.tag) }}</span>
			</div>
		    </div>
		</div>
		<div class="form-group">
		    {{ form_label(form.checkInAt) }}:
		    <div class="row">
			<div class="col-md">
			    {{ form_widget(form.checkInAt) }}
			    <span class="text-danger">{{ form_errors(form.checkInAt) }}</span>
			</div>
		    </div>
		</div>
		<div class="form-group">
		    {{ form_label(form.checkOutAt) }}:
		    <div class="row">
			<div class="col-md">
			    {{ form_widget(form.checkOutAt) }}
			    <span class="text-danger">{{ form_errors(form.checkOutAt) }}</span>
			</div>
		    </div>
		</div>

		<div class="d-grid gap-2 d-md-block">
		    <button type="submit" value="Save" class="btn btn-primary">{% trans %}Save{% endtrans %}</button>
		    <button type="reset" value="Reset" class="btn btn-secondary">{% trans %}Reset{% endtrans %}</button>
		    <a class="btn btn-link" href="{{ path('app_attendance_index') }}" role="button">{% trans %}Back to list{% endtrans %}</a>
		</div>
	    {{ form_end(form) }}
	</div>
	<div class="col-md-6 d-flex align-items-center justify-content-center">
	    <video id="video" width="480" height="360" class="border" autoplay></video>
	    <canvas id="canvas" style="display:none;"></canvas>
	</div>
    </div>
{% endblock %}

{% block custom_javascripts %}
    <script>
     document.addEventListener('DOMContentLoaded', (event) => {
	 const video = document.getElementById('video');
	 const canvas = document.getElementById('canvas');
	 const form = document.querySelector('form');
	 const evidenceField = document.getElementById('attendance_evidence');

	 if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
	     console.error('Browser API navigator.mediaDevices.getUserMedia not available');
	     return;
	 }

	 navigator.mediaDevices.getUserMedia({ video: true, audio: false })
		  .then(function(stream) {
		      video.srcObject = stream;
		      video.play();
		  })
		  .catch(function(err) {
		      console.log("An error occurred: " + err);
		  });

	 if (form) {
	     form.addEventListener('submit', function(event) {
		 event.preventDefault();

		 if (!video.srcObject) {
		     console.error('Video stream not available');
		     return;
		 }

		 const context = canvas.getContext('2d');
		 canvas.width = 270; {# 640 - 480 #}
		 canvas.height = 203; {# 480 - 360 #}
		 context.drawImage(video, 0, 0, canvas.width, canvas.height);

		 const dataURL = canvas.toDataURL('image/png');
		 evidenceField.value = dataURL;

		 form.submit();
	     });
	 } else {
	     console.error('Form not found');
	 }
     });
    </script>
{% endblock %}
